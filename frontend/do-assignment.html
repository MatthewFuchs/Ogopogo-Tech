<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do Assignment</title>
    <link rel="stylesheet" href="css/assignment.css"> <!-- Ensure correct path -->
</head>
<body>

<main>
    <div class="container" id="doAssignment">
        <h2 id="assignmentTitle">Assignment Title</h2>
        <p id="assignmentDescription">Complete the questions below and submit your answers.</p>
        
        <form id="assignmentForm">
            <div id="questionContainer">
                <!-- Questions -->
            </div>

            <!-- Submit button for assignment -->
            <button type="submit" class="btn-explore">Submit Assignment</button>
        </form>
    </div>
</main>

<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const assignmentId = urlParams.get('assignmentId');
    let token = localStorage.getItem('userToken');
    if (!token) {
        token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY2MDBlOTgxOTZjMmRkNTQxY2ZmYzdlNyIsImlhdCI6MTcxMTMzNTgwOSwiZXhwIjoxNzEzOTI3ODA5fQ.UFgAtXOeg1r7j-4Ug5DOgN_EG1gqbjNkihJMKeC9mXY'
    }

    document.addEventListener('DOMContentLoaded', async () => { 
        // Fetch questions from API
        try {
            const response = await fetch(`http://localhost:8080/api/assignments/${assignmentId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            const questions = data.questions;

            const assignmentTitle = document.getElementById('assignmentTitle');
            assignmentTitle.innerHTML = data.title;
            const assignmentDescription = document.getElementById('assignmentDescription');
            assignmentDescription.innerHTML = data.description;

            // Generate HTML for each question
            const questionContainer = document.getElementById('questionContainer');
            questions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.classList.add('question-item');
                questionItem.innerHTML = `
                    <label for="question${index + 1}">${index + 1}. ${question}</label>
                    <input type="text" id="question${index + 1}" name="question${index + 1}" class="form-control" required>
                `;
                questionContainer.appendChild(questionItem);
            });
        } catch (error) {
            console.error('Error fetching questions:', error);
        }
    });

    document.getElementById('assignmentForm').onsubmit = async function(event) {
    event.preventDefault();
    const answers = document.querySelectorAll('.question-item input[type="text"]');
    
    // Array to store promises for each answer submission
    const answerPromises = [];

    answers.forEach(async (answer, index) => {
        const answerText = answer.value;

        // Assuming you are using fetch API for AJAX calls
        const response = await fetch(`http://localhost:8080/api/assignments/answer/${assignmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ answer: answerText, questionNum: (index + 1) })
        });

        const data = await response.json();
        console.log('Answer submitted:', data);
        answerPromises.push(response);
    });

    // Wait for all answer submissions to complete
    Promise.all(answerPromises)
    .then(async () => {
        const response = await fetch(`http://localhost:8080/api/assignments/submit/${assignmentId}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            }
        });
        alert('Assignment submitted!');
        window.location.href = 'assignments-list-student.html'; // Redirect to student's assignments list
    })
    .catch(error => {
        console.error('Error submitting answers:', error);
        alert('Error submitting answers. Please try again.');
    });
};
</script>

</body>
</html>
