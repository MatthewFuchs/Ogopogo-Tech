<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Do Assignment</title>
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/do-assignment.css">
</head>
<body>

<header class="topbar">
    <section class="user-profile">
        <a href="profile.html">User Profile</a>
    </section>
    <nav class="nav-menu">
        <ul>
            <li><a href="index.html">Courses</a></li>
            <li><a href="assignments-list-student.html">Assignments</a></li>
            <li><a href="grades.html">Grades</a></li>
            <li><a href="help.html">Help</a></li>
        </ul>
    </nav>
    <section class="logout">
        <a href="log-out.html">Log Out</a>
    </section>
</header>

<main class="main-content">
    <article class="assignment-container">
        <h2 id="assignmentTitle">Assignment Title</h2>
        <p id="assignmentDescription">Complete the questions below and submit your answers.</p>
        
        <form id="assignmentForm">
            <div id="questionContainer">
                <!-- Questions -->
            </div>

            <!-- Submit button for assignment -->
            <button type="submit" id="buttonSubmit" class="btn-explore">Submit Assignment</button>
        </form>
    <link rel="stylesheet" href="css/assignment.css"> <!-- Ensure correct path -->
</main>
<body>

<footer class="footer">
    <p>&copy; 2024 Ogopogo Tech. All rights reserved.</p>
</footer>

<script>
    let studentID;
    const queryString = window.location.search;
const urlParams = new URLSearchParams(queryString);
const assignmentId = urlParams.get('assignmentId');

// Add the console log here to check the assignmentId
console.log('Assignment ID:', assignmentId);
    let token = localStorage.getItem('userToken');
    if (!token) {
        token = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpZCI6IjY2MDBlOTgxOTZjMmRkNTQxY2ZmYzdlNyIsImlhdCI6MTcxMTMzNTgwOSwiZXhwIjoxNzEzOTI3ODA5fQ.UFgAtXOeg1r7j-4Ug5DOgN_EG1gqbjNkihJMKeC9mXY'
    }

    document.addEventListener('DOMContentLoaded', async () => { 
        // Fetch questions from API
        try {
            const response = await fetch(`http://localhost:8002/api/assignments/${assignmentId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });
            const data = await response.json();
            const questions = data.questions;

            const assignmentTitle = document.getElementById('assignmentTitle');
            assignmentTitle.innerHTML = data.title;
            const assignmentDescription = document.getElementById('assignmentDescription');
            assignmentDescription.innerHTML = data.description;

            // Generate HTML for each question
            const questionContainer = document.getElementById('questionContainer');
            questions.forEach((question, index) => {
                const questionItem = document.createElement('div');
                questionItem.classList.add('question-item');
                questionItem.innerHTML = `
                    <label for="question${index + 1}">${index + 1}. ${question}</label>
                    <input type="text" id="question${index + 1}" name="question${index + 1}" class="form-control" required>
                `;
                questionContainer.appendChild(questionItem);
            });
        } catch (error) {
            console.error('Error fetching questions:', error);
        }
    });

    document.addEventListener('DOMContentLoaded', async () => { 
    // Fetch the assignment details
    try {
        const response = await fetch(`http://localhost:8002/api/assignments/${assignmentId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
        const data = await response.json();
        
        const assignmentTitle = document.getElementById('assignmentTitle');
        assignmentTitle.innerHTML = data.title;
        const assignmentDescription = document.getElementById('assignmentDescription');
        assignmentDescription.innerHTML = data.description;

        // Generate HTML based on assignment type
        const questionContainer = document.getElementById('questionContainer');
        switch(data.type) {
            case 'multiquestion':
                data.questions.forEach((question, index) => {
                    const questionItem = document.createElement('div');
                    questionItem.classList.add('question-item');
                    questionItem.innerHTML = `
                        <label for="question${index + 1}">${index + 1}. ${question}</label>
                        <input type="text" id="question${index + 1}" name="question${index + 1}" class="form-control" required>
                    `;
                    questionContainer.appendChild(questionItem);
                });
                break;
            case 'mcq':
                data.questions.forEach((question, index) => {
                    // Assuming 'question' is an object with 'text' and 'options'
                    const questionItem = document.createElement('div');
                    questionItem.classList.add('question-item');
                    let optionsHTML = question.options.map((option, optionIndex) => 
                        `<input type="radio" id="option${optionIndex}" name="question${index + 1}" value="${option}"> <label for="option${optionIndex}">${option}</label>`
                    ).join('<br>');
                    questionItem.innerHTML = `
                        <label>${index + 1}. ${question.text}</label>
                        <div>${optionsHTML}</div>
                    `;
                    questionContainer.appendChild(questionItem);
                });
                break;
            case 'essay':
                questionContainer.innerHTML = `
                    <label for="fileUpload">Upload your essay:</label>
                    <input type="file" id="fileUpload" name="fileUpload" required>
                `;
                break;
        }
    } catch (error) {
        console.error('Error fetching questions:', error);
    }
});




async function handleSubmission(event) {
    event.preventDefault(); // Prevent the default form submission behavior

    // Retrieve the user's _id from localStorage
    const userId = localStorage.getItem('userId');
    if (!userId) {
        alert("User ID not found, please log in again.");
        return; // Stop the submission if no user ID is found
    }

    const fileInput = document.getElementById('fileUpload');
    const formData = new FormData();

    // Append the student ID to the formData
    formData.append('studentID', userId);

    // Add file to formData if it exists
    if (fileInput && fileInput.files.length > 0) {
        formData.append('assignmentFile', fileInput.files[0]);
    }

    try {
        const response = await fetch(`http://localhost:8002/api/assignments/submit/${assignmentId}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
                // Don't set Content-Type here, let the browser do it
            },
            body: formData
        });

        // Log the response and error if not OK
        if (!response.ok) {
            const errorResponse = await response.text(); // Get the raw response body
            console.error('Submission error:', errorResponse); // Log raw response body
            alert(`Error during submission: ${errorResponse}`);
        } else {
            const result = await response.json();
            alert('Assignment submitted successfully!');
            console.log(result);
            window.location.href = 'assignments-list-student.html';
        }
    } catch (error) {
        console.error('Error during submission:', error);
        alert('Error! Assignment not submitted. ' + error.message);
    }
}




</script>

</body>
</html>
